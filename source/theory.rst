
.. note::
    Overall, I think this is a good section to have, as it, obviously, 
    describes what is going on in the code. I think it's important to address 
    how it is both pitched and structured, however.

    By pitched I mean that the way this page is written, with the level of 
    assumed knowledge, it is pretty much only accessible to naval architects / 
    ocean engineers or people in an academic institution that can access the 
    materials required to learn it, with the implication that the necessary 
    background to both use and develop the code is limited them. I understand 
    that development of this code is probably going to be limited due to its 
    complexity and the challenge of gathering the references required to learn 
    it, but I suspect you want the user base to be more broad. In this case I 
    would consider having a theory section that provides a detailed (with 
    accessible references if used) description of the theory required for 
    understanding the use and another section (similar to this page) that is 
    for people who can go deeper to get involved in the development. 

    The structure of this page could also be improved. In some ways it's like a 
    narrative, in some ways like and manual and it never quite works as either. 
    I think the introduction needs to be improved to say who the information is 
    for and what background level is required (which should be addressed 
    earlier in the docs as well) and to provide some guidance for how the page 
    is structured. The order and level of some of the sections need some 
    sorting also. 

.. _theory:

Theory
======
Modeling wave energy converters (WECs) involves the interaction between the incident waves, device motion, power-take-off (PTO mechanism), and mooring. WEC-Sim uses a radiation and diffraction method :cite:`Li2012,Babarit2012` to predict power performance and design optimization. The radiation and diffraction method generally obtains the hydrodynamic forces from a frequency-domain boundary element method (BEM) solver using linear coefficients to solve the system dynamics in the time domain.

.. note::
     I'm sure that the references are good, but because they are paywalled,
     they are not immediately useful to explain the meaning of this theory.
     Are there more accessible sources?

.. _wec_sim_methodology:

.. figure:: _images/Physics.png
    :align: center
        
    ..

.. note::
     I don't think this diagram adds much understanding and perhaps there is
     a missed opportunity with this intro to guide the reader through this
     page, a bit. It's like a gentle push to a long hard landing.

Coordinate System
------------------
The :ref:`WEC-Sim Coordinate System <coordinate_system>` figure illustrates a 3-D floating point absorber subject to incoming waves in water. The figure also defines the coordinates and the 6 degree of freedom (DOF) in WEC-Sim. The WEC-Sim coordinate system assumes that the positive X-axis defines a wave angle heading of zero (e.g., a wave propagating with along a zero-degree direction is moving in the +X direction). The positive Z-axis is in the vertical upwards direction, and the positive Y-axis direction is defined by the right-hand rule. In the vectors and matrices used in the code, Surge (x), Sway (y), and Heave (z) correspond to the first, second and third position respectively. Roll (Rx), Pitch (Ry), and Yaw (Rz) correspond to the fourth, fifth, and sixth position respectively.

.. _coordinate_system:

.. figure:: _images/coordinateSystem.png
    :align: center
    :width: 200pt    
    
    ..

    *WEC-Sim Coordinate System*

.. note::
    In terms of the x-axis definition, I think this leaves a little confusion
    regarding whether wave angles should be given in bearings or using a
    Cartesian definition.


Units
------
All units within WEC-Sim are in the MKS (meters-kilograms-seconds system) and angular measurements are specified in radians (except for wave directionality which is defined in degrees).

.. note::
    I'm probably being a bit dim, but why MKS and not SI units? The use of
    degrees for wave direction again makes me wonder if we are talking about
    bearings or not.

Boundary Element Method (BEM)
-----------------------------
In WEC-Sim, wave forcing components are modeled using linear coefficients  obtained from a frequency-domain potential flow Boundary Element Method (BEM) solver (e.g., WAMIT :cite:`Lee2006`, AQWA :cite:`AQWA`, and Nemoh :cite:`NEMOH`). 
The BEM solutions are obtained by solving the Laplace equation for the velocity potential, which assumes the flow is inviscid, incompressible, and irrotational. More details on the theory for the frequency-domain BEM can be found in :cite:`Lee2006`.

.. note::
    What is a "wave forcing component"? I googled it, but without much luck.

WEC-Sim imports non-dimensionalized hydrodynamic coefficients from an ``*.h5``  data structure generated by :ref:`bemio` for the WAMIT, AQWA or Nemoh BEM solvers. 
Alternatively, the ``*.h5`` data structure can be manually defined by the user. 
The WEC-Sim code scales the hydrodynamic coefficients according to the equations below, where :math:`\rho` is the water density, :math:`\omega` is the wave frequency in rad/s, and :math:`g` is gravity:

.. note::
    I don't think you need to talk about the h5 files or BEMIO here.

.. math::

	|\overline{F_{exc}(\omega)}|=\frac{|F_{exc}(\omega)|}{\rho g}
	
	\overline{A(\omega)} = \frac{A(\omega)}{\rho}
	
	\overline{B(\omega)} = \frac{B(\omega)}{\rho \omega}
	
	\overline{K_{hs}} = \frac{K_{hs}}{\rho g}

where :math:`F_{exc}` is the wave-excitation force/torque coefficient, :math:`A` is the radiation added mass coefficient, :math:`B` is the radiation wave damping coefficient, and :math:`K_{hs}` is the linear hydrostatic restoring coefficient.

.. note::
    Why are half of the definitions above the equations and half below? OK, I 
    think you are trying to say that the variables above the equation are the
    scaling factors, but it needs to be more explicit, I would say.

Time-Domain Formulation
-------------------------
A common approach to determining the hydrodynamic forces is to use linear wave theory which assumes the waves are the sum of incident, radiated, and diffracted wave components. 
The dynamic response of the system is calculated by solving WEC system equations of motion :cite:`Babarit2012,Nolte2014`. 
The equation of motion for a floating body about its center of gravity can be given as:

.. note::
    Another paywalled reference here. Are they cited here because this theory
    follows that work? Or are they just examples of the use of it. Would be
    good to know so I can decide if I want to pay for them or not.

.. math::
    :label: motion
    
    m\ddot{X}=F_{exc}(t)+F_{rad}(t)+F_{pto}(t)+F_{v}(t)+F_{me}(t)+F_{B}(t)+F_{m}(t)

where :math:`\ddot{X}` is the (translational and rotational) acceleration vector of the device, :math:`m` is the mass matrix, :math:`F_{exc}(t)` is the wave excitation force and torque (6-element) vector, :math:`F_{rad}(t)` is the force and torque vector resulting from wave radiation, :math:`F_{pto}(t)` is the PTO force and torque vector, :math:`F_{v}(t)` is the damping force and torque vector, :math:`F_{me}(t)` is the Morison Element force and torque vector, :math:`F_{B}(t)` is the net buoyancy restoring force and torque vector, and :math:`F_{m}(t)` is the force and torque vector resulting from the mooring connection.

.. note::
    This would be easier to read in a bullet list

:math:`F_{exc}(t)` , :math:`F_{rad}(t)` , and :math:`F_{B}(t)` are calculated using hydrodynamic coefficients provided by the frequency-domain BEM solver. 
The radiation term includes an added-mass term, matrix :math:`A(\omega)`, and wave damping term, matrix :math:`B(\omega)`, associated with the acceleration and velocity of the floating body, respectively, and given as functions of radian frequency (:math:`\omega`) by the BEM solver. 
The wave excitation term :math:`F_{exc}(\omega)` includes a Froude-Krylov force component generated by the undisturbed incident waves and a diffraction component that results from the presence of the floating body. 
The buoyancy term :math:`F_{B}(t)` depends on the hydrostatic stiffness :math:`K_{hs}` coefficient, displacement of the body, and its mass.

.. note::
    And the other 4 terms come from? 

Numerical Methods
------------------
WEC-Sim can be used for regular and irregular wave simulations, but note that :math:`F_{exc}(t)` and :math:`F_{rad}(t)` are calculated differently for sinusoidal steady-state response scenarios and random sea simulations. 
The sinusoidal steady-state response is often used for simple WEC designs with regular incoming waves. 
However, for random sea simulations or any simulations where fluid memory effects of the system are essential, the convolution integral method is recommended to represent the fluid memory retardation force on the floating body. 
To speed computation of the convolution integral, the state space representation method can be specified to approximate this calculation as a system of linear ordinary differential equations. 

.. note::
    "fluid memory effects"? Need that one on your terminology page. Actually,
    a link to your terminology page on this page would be really useful.

.. note::
    I don't really get how the paragraph above relates to the section below.
    I guess these are numerical methods used in certain stages of WEC-Sim?
    It's really not clear how this all relates.

Ramp Function
^^^^^^^^^^^^^^^^^^^^^^^

.. note:: 
    Looking below, I see how it is used now, but it really breaks up the flow 
    of this section. I would be tempted to just define it in the steady state 
    section. I'm not sure this function "is used to calculate the wave 
    excitation force" either. It's used to modify it, but I'm guessing the 
    total force isn't 1 for t >= t_r? Also why define these inequalities with
    fractions? It just makes it more difficult to read.

A ramp function (:math:`R_{f}`), necessary to avoid strong transient flows at the earlier time steps of the simulation, is used to calculate the wave excitation force. The ramp function is given by

.. math::

	R_{f}(t)=\begin{cases}
	\frac{1}{2}(1+\cos(\pi+\frac{\pi t}{t_{r}}) & \frac{t}{t_{r}}<1\\
	1 & \frac{t}{t_{r}}\geq1
	\end{cases}

where :math:`t` is the simulation time and :math:`t_{r}` is the ramp time.

.. note::
    Who sets the ramp time?

Sinusoidal Steady-State Response 
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

.. note::
    I think a diagram showing a "sinusoidal system response in steady-state 
    form" would be helpful to explain this case.

This approach assumes that the system response is in sinusoidal steady-state form; therefore, it is only valid for regular wave simulations. The radiation term can be calculated using the added mass and the wave radiation damping term for a given wave frequency, which is obtained from

.. math::

	F_{rad}(t)=-A(\omega)\ddot{X}-B(\omega)\dot{X}

where :math:`\dot{X}` is the velocity vector of the floating body.

.. note::
    Why mention the free surface profile here? Is it used somewhere else outside
    of this section?

The free surface profile is based on linear wave theory for a given wave height, wave frequency, and water depth. The regular wave excitation force is obtained from

.. math::

	F_{exc}(t)=\Re\left[ R_{f}(t)\frac{H}{2}F_{exc}(\omega, \theta)e^{i\omega t} \right]


where :math:`\Re` denotes the real part of the formula, :math:`R_{f}` is the ramp function, :math:`H` is the wave height, :math:`F_{exc}` is the frequency dependent complex wave-excitation amplitude vector, and :math:`\theta` is the wave direction.

Convolution Integral Formulation
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

.. note:: 
    The wikipedia page for `convolutions 
    <https://en.wikipedia.org/wiki/Convolution>`_ might be helpful to link
    here.

To include the fluid memory effect, the convolution integral formulation based upon the Cummins equation :cite:`Cummins1962` is used. The radiation term can be calculated by

.. math::

	F_{rad}(t)=-A_{\infty}\ddot{X}-\intop_{0}^{t}K_{r}(t-\tau)\dot{X}(\tau)d\tau

where :math:`A_{\infty}` is the added mass matrix at infinite frequency and :math:`K_{r}` is the radiation impulse response function. This representation also assumes that there is no motion for :math:`t<0`.

.. note::
    Probably better to use `equation referencing <https://www.sphinx-doc.org/en/master/usage/restructuredtext/domains.html#role-math-numref>`_
    rather than say "the equation described in the last subsection". I added
    a fix to the RTD css to get this to work, if that was the issue.

.. note::
    The free surface is mentioned again here, but it's usage is not described
    anywhere. Is it calculated just for fun?

.. note::
    There is a section on wave spectra later on, which should probably be
    linked to.

For regular waves, the equation described in the last subsection is used to calculate the wave excitation vector.
For irregular waves, the free surface elevation is constructed from a linear superposition of a number of regular wave components. 
Each regular wave component is extracted from a wave spectrum, :math:`S(\omega)`, describing the wave energy distribution over a range of wave frequencies, generally characterized by a significant wave height and peak wave period. The irregular excitation force can be calculated as the real part of an integral term across all wave frequencies as follows 

.. math::

	F_{exc}(t)=\Re\left[ R_{f}(t) \sum_{j=1}^{N}F_{exc}(\omega_{j}, \theta)e^{i(\omega_{j}t+\phi_{j})} \sqrt{2S(\omega_{j})d\omega_{j}} \right]

.. note:: 
    I might be being thick, again, but I don't see the integral term in 
    this equation.

where :math:`\phi` is the randomized phase angle and :math:`N` is the number of frequency bands selected to discretize the wave spectrum. For repeatable simulation of an irregular wave field :math:`S(\omega)`, WEC-Sim allows specification of :math:`\phi`, refer to the :ref:`seeded_phase` section. 

.. note::
    Regarding the random phase angle, a better approach would be to treat this 
    as a statistical problem, as the mean and the extremes will be useful in 
    different design cases. Overall, I don't think a single sample (even if you 
    can make it repeatable by fixing the random seed), is that informative. 

State Space  
^^^^^^^^^^^^^^^^^^^^^^^

.. note::
    More paywalled references here. `Here 
    <https://en.wikipedia.org/wiki/State-space_representation>`_ is a wikipedia
    page that is useful. I think it's also worth mentioning that this is moving
    into the electrical analogue kind of approach now.

.. note::
    I don't see reuse of the abbreviation SS

It is highly desirable to represent the radiation convolution integral described in the last subsection in state space (SS) form :cite:`Yu1996`.  This has been shown to dramatically increase computational speeds :cite:`Taghipour2008` and allow utilization of conventional control methods that rely on linear state space models.  An approximation will need to be made as :math:`K_{r}` is solved from a set of partial differential equations where as a `linear state space` is constructed from a set of ordinary differential equations.  In general, a linear system is desired such that:

.. math::

	\dot{X}_{r} \left( t \right) = \mathbf{A_{r}} X_{r} \left( t \right) + \mathbf{B_{r}} \mathbf{u} (t);~~X_{r}\left( 0 \right) = 0~~ \nonumber \\
	\int_{0}^{t} \mathbf{K_{r}} \left( t- \tau \right) d\tau \approx \mathbf{C_{r}} X_{r} \left( t \right) + \mathbf{D_{r}} \mathbf{u} \left( t \right)~~

with :math:`\mathbf{A_{r}},~\mathbf{B_{r}},~\mathbf{C_{r}},~\mathbf{D_{r}}` being the time-invariant state, input, output, and feed through matrices, while :math:`u` is the input to the system and :math:`X_{r}` is the state vector describing the convolution kernal as time progresses.

Calculation of :math:`K_{r}` from State Space Matrices
""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""

.. note::
    What does "zero-state" mean?

The impulse response of a single-input zero-state state-space model is represented by

.. math::

	\dot{x} =  \mathbf{A_{r}}x + \mathbf{B_{r}} u~~ \\
	y = \mathbf{C_{r}}x~~

where :math:`u` is an impulse. If the initial state is set to :math:`x(0)= \mathbf{B_{r}} u` the response of the unforced (:math:`u=0`) system

.. note::
    The initial state of which equation?

.. math::

	\dot{x} = \mathbf{A_{r}} x~~, \\
	y = \mathbf{C_{r}} x~~

is clearly equivalent to the zero-state impulse response. The impulse response of a continuous system with a nonzero :math:`\mathbf{D_r}` matrix is infinite at :math:`t=0`; therefore, the lower continuity value :math:`\mathbf{C_{r}}\mathbf{B_{r}}` is reported at :math:`t=0`. The general solution to a linear time invariant (LTI) system is given by:

.. note::
    I don't follow how the zero-state model relates to the general solution.

.. math::

	x(t) = e^{\mathbf{A_{r}}t} x(0) + \int_{0}^{t} e^{\mathbf{A_{r}}(t-\tau)} \mathbf{B_{r}} u (\tau) d\tau~~

where :math:`e^{\mathbf{A_{r}}}` is the matrix exponential and the calculation of :math:`K_{r}` follows:

.. math::

	K_{r}(t) = \mathbf{C_{r}}e^{\mathbf{A_{r}}t}\mathbf{B_{r}}~~

.. note::
    OK, that's fine, I guess, but I don't really see how this helps in finding
    :math:`F_{rad}(t)`?

Realization Theory
""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""

.. note::
    I don't see reuse of the abbreviation TD.

.. warning::
    There is a lot of jargon in this section, such as "feedthrough matrix".

The state space realization of the hydrodynamic radiation coefficients can be pursued in the time domain (TD). This consists of finding the minimal order of the system and the discrete time state matrices (:math:`\mathbf{A_{d}},~\mathbf{B_{d}},~\mathbf{C_{d}},~\mathbf{D_{d}}`) from samples of the impulse response function.  This problem is easier to handle for a discrete-time system than for continuous-time. The reason being is that the impulse response function of a discrete-time system is given by the Markov parameters of the system:

.. math::

	\mathbf{\tilde{K}_{r}} \left( t_{k} \right) = \mathbf{C_{d}}\mathbf{A_{d}}^{k}\mathbf{B_{d}}~~

where :math:`t_{k}=k\Delta t` for :math:`k=0,~1,~2,~\ldots` with :math:`\Delta t` being the sampling period.  The feedthrough matrix :math:`\mathbf{D_d}` is assumed to be zero in order to maintain causality of the system, as a non-zero :math:`\mathbf{D_d}` results in an infinite value at :math:`t=0`.

.. note::
    The reference here is simply not obtainable.

The most common algorithm to obtain the realization is to perform a Singular Value Decomposition (SVD) on the Hankel matrix of the impulse response function, as proposed by Kung :cite:`Kung1978`.  The order of the system and state-space parameters are determined from the number of significant singular values and the factors of the SVD.  The Hankel matrix (:math:`H`) of the impulse response function

.. math::

	H = \begin{bmatrix}
    		\mathbf{K_{r}}(2) & \mathbf{K_{r}}(3) & \ldots & \mathbf{K_{r}}(n) \\
       		\mathbf{K_{r}}(3) & \mathbf{K_{r}}(4) & \ldots & 0 \\
       		\vdots & \vdots & \ddots & \vdots \\
       		\mathbf{K_{r}}(n) & 0 & \cdots & 0
      	\end{bmatrix} &\\ 

can be reproduced exactly by the SVD as

.. math::

	H = \mathbf{U} \Sigma \mathbf{V^{*}}

where :math:`\Sigma` is a diagonal matrix containing the Hankel singular values in descending order.  Examination of the Hankel singular values reveals there are only a small number of significant states and that the rank of :math:`H` can be greatly reduced without a significant loss in accuracy :cite:`Taghipour2008,Kristiansen2005`. Further detail into the SVD method and calculation of the state space parameters will not be discussed here and the reader is referred to :cite:`Taghipour2008,Kristiansen2005`.

.. note::
    I'm not sure I'm any wiser after this section, TBH. I'm taking that there 
    is a simplification that can be done, but I'm not even sure if that's the 
    take away.


Regular Waves
-------------

.. note::
    This section and the next should be in a higher level section called
    "Wave Generation". In fact, the section naming in this page is not great,
    overall, and should relate more to where this theory is used in the code.

Regular waves are defined as planar sinusoidal waves, where the incident wave is defined as :math:`\eta(x,y,t)` :

.. math::

	\eta(x,y,t)= \frac{H}{2} \cos( \omega t - k (x\cos \theta + y\sin \theta) + \phi)

where :math:`H` is the wave height, :math:`\omega` is the wave frequency  (:math:`\omega = \frac{2\pi}{T}`), :math:`k` is the wave number (:math:`k = \frac{2\pi}{\lambda}`), :math:`\theta` is the wave direction, and :math:`\phi` is the wave phase.   

.. note::
    And :math:`T` is the wave period, and :math:`\lambda` is the wave length.

Irregular Waves
----------------

Irregular waves are modeled as the linear superposition of a large number of harmonic waves at different frequencies and angles of incidence, where the incident wave is defined as :math:`\eta(x,y,t)` :

.. math::

	\eta(x,y,t)= \sum_{i}\frac{H_{i}}{2} \cos( \omega_{i} t - k_{i} (x\cos \theta_{i} + y\sin \theta_{i}) + \phi_{i})

where :math:`H` is the wave height, :math:`\omega` is the wave frequency  (:math:`\omega = \frac{2\pi}{T}`), :math:`k` is the wave number (:math:`k = \frac{2\pi}{\lambda}`), :math:`\theta` is the wave direction, and :math:`\phi` is the wave phase (randomized for irregular waves).   


Wave Spectra
^^^^^^^^^^^^^^^^^^^^^^^
The linear superposition of regular waves of distinct amplitudes and periods is characterized in the frequency domain by a wave spectrum. Through statistical analysis, spectra are characterized by specific parameters such as significant wave height, peak period, wind speed, fetch length, and others. Common types of wave spectra that are used by the offshore industry are discussed in the following sections.  The general form of the wave spectra available in WEC-Sim is given by:

.. math::

	S\left( f , \theta \right)= S\left( f \right)D\left( \theta \right)~~
	
where :math:`S\left( f\right)` is the wave power spectrum, :math:`f` is the wave frequency (in Hertz), :math:`D\left( \theta \right)` is the directional distribution, and :math:`\theta` is the wave direction (in Degrees). The formulation of :math:`D\left( \theta \right)` requires that

.. math::

	\int_{0}^{\infty}\int_{-\pi}^{\pi} S\left( f \right)D\left( \theta \right) d\theta df = \int_{0}^{\infty} S\left( f \right) df

so that the total energy in the directional spectrum must be the same as the total energy in the one-dimensional spectrum.

.. note::
    Where did this eq below come from???? It seems totally out of place here and 
    maybe should go at the end, saying this is the general PM spectrum 
    (according to Falnes), the coefficients of which can describe a number of 
    different spectra.

.. math::
	
	S\left( f \right) = A f^{-5}\exp\left[-B f^{-4} \right]~~

where :math:`A` and :math:`B` are coefficients that vary depending on the wave spectrum and :math:`\exp` stands for the exponential function. Spectral moments of the wave spectrum, denoted :math:`m_{k}~,~k=0, 1, 2,...`, are defined as

.. note::
    It's weird because you go back to the general form of S here.

.. math::
	m_{k} = \int_{0}^{\infty} f^{k} S \left( f \right) df ~~

The spectral moment, :math:`m_{0}` is the variance of the free surface which allows one to define the mean wave height of the tallest third of waves, significant wave height  :math:`H_{m0}` (in m), as:

.. math::
	H_{m0} = 4 \sqrt{m_{0}}~~



Pierson--Moskowitz (PM)
""""""""""""""""""""""""
The PM spectrum is applicable to a fully developed sea, when the growth of the waves is not limited by the fetch :cite:`PM`. The two-parameter PM spectrum is based on a significant wave height and peak wave frequency.  For a given significant wave height, the peak frequency can be varied to cover a range of conditions including developing and decaying seas. In general, the parameters depend strongly on wind speed, and also wind direction, fetch, and locations of storm fronts. The spectral density of the surface elevation defined by the PM spectrum :cite:`IEC-2` is defind by:

.. math::

	S_{PM}\left( f \right) = \frac{{H_{m0}}^2}{4}\left(1.057f_{p}\right)^{4}f^{-5}\exp\left[-\frac{5}{4} \left( \frac{f_{p}}{f}\right)^{4} \right]~~ \\
	
This implies coefficients of the general form:

.. math::	
	
	A =\frac{{H_{m0}}^2}{4}\left(1.057f_{p}\right)^{4} \approx \frac{5}{16} {H_{m0}}^2 {f_{p}}^{4} \approx \frac{B}{4}{H_{m0}}^2~~ \\ 
	B = \left(1.057f_{p}\right)^{4} \approx \frac{5}{4}{f_{p}}^{4}~~ \\
	
where :math:`H_{m0}` is the significant wave height, :math:`f_{p}` is the peak wave frequency :math:`\left(=1/T_{p}\right)`, and :math:`f` is the wave frequency. 
	
JONSWAP (JS)
""""""""""""""""""""""""
The JONSWAP (Joint North Sea Wave Project) spectrum is formulated as a modification of the PM spectrum for developing sea sate in a fetch-limited situation :cite:`HK`. The spectrum accounts for a higher peak and a narrower spectrum in a storm situation for the same total energy as compared to the PM spectrum. The spectral density of the surface elevation defined by the JS spectrum :cite:`IEC-2` is defined by:

.. math::
	S_{JS}\left( f \right) = C \left(\gamma\right) S_{PM} \gamma^{\alpha} \\
	
where :math:`\gamma` is the non-dimensional peak-shape parameter.

The normalizing factor, :math:`C\left(\gamma\right)`, is defind as: 

.. math:: 
	C\left(\gamma\right) = \frac{\int_{0}^{\infty}S_{PM}\left(f\right)df}{\int_{0}^{\infty}S_{PM}\left(f\right)\gamma^{\alpha}df} = 1 -0.287\ln\left(\gamma\right)\\

The peak-shape parameter exponent :math:`\alpha` is defined as:

.. math::
	\alpha = \exp \left[ -\left( \frac{\frac{f}{f_{p}}-1}{\sqrt{2} \sigma}\right)^{2} \right],~~ \sigma = \begin{cases} 0.07 & f \leq f_{p} \\0.09 & f > f_{p} \end{cases} ~~ \\
	
The peak-shape parameter is defined based on the following relationship between the significant wave height, :math:`H_{m0}`, and peak period, :math:`T_{p}`:

.. math:: 
	\gamma = \begin{cases} 
		5 & \text{for } \frac{T_{p}}{\sqrt{H_{m0}}} \leq 3.6\\    
        	\exp\left(5.75 - 1.15\frac{T_{p}}{\sqrt{H_{m0}}} \right) &  \text{for } 3.6 \leq \frac{T_{p}}{\sqrt{H_{m0}}} \leq 5 \\
        	1 & \text{for } \frac{T_{p}}{\sqrt{H_{m0}}} > 5
	\end{cases}
	
with general form coefficients thus defined:

.. math::
	A = \frac{B}{4}{H_{m0}}^2 C\left(\gamma \right) \gamma^{\alpha} \\
	B = \frac{5}{4}{f_{p}}^{4} \\

Power Take-Off (PTO)
--------------------

Throughout the following sections, unless specification is made between linear and rotary PTOs, units are not explicitly stated.

.. note::
    I don't think there are any rotary PTOs, right?

Linear PTO
^^^^^^^^^^^^^^^^^^^^^^^
The PTO mechanism is represented as a linear spring-damper system where the reaction force is given by: 

.. math::

	F_{pto}=-K{}_{pto}X_{rel}-C_{pto}\dot{X}_{rel}

where :math:`K_{pto}` is the stiffness of the PTO, :math:`C_{pto}` is the damping of the PTO, and :math:`X_{rel}` and :math:`\dot{X}_{rel}` are the relative motion and velocity between two bodies. 
The instantaneous power absorbed by the PTO is given by:

 .. math::
	
	P_{pto} = -F_{pto}\dot{X}_{rel}=\left(K_{pto}X_{rel}\dot{X}_{rel}+C_{pto}\dot{X}^{2}_{rel}\right)

.. note::
    This equation is basically repeated three times and could maybe be introduced
    in the introduction to the section once instead.

Hydraulic PTO
^^^^^^^^^^^^^^^^^^^^^^^

The PTO mechanism is modeled as a hydraulic system :cite:`So`, where the reaction force is given by:

.. math::

	F_{pto}=\Delta{} p_{piston}A_{piston}

where :math:`\Delta{} p_{piston}` is the differential pressure of the hydraulic piston and :math:`A_{piston}` is the piston area. 
The instantaneous hydraulic power absorbed by the PTO is given by:  

.. math::

	P_{pto}=-F_{pto}\dot{X}_{rel}


Mechanical PTO
^^^^^^^^^^^^^^^^^^^^^^^

.. note::
    It's a little confusing that this is a linear generator but not a linear
    PTO.

The PTO mechanism is modeled as a direct-drive linear generator system :cite:`So`, where the reaction force is given by:

.. math::

	F_{pto}=(\frac{\pi}{\tau_{pm}})\lambda_{fd}i_{sq}

where :math:`\tau_{pm}` is the magnet pole pitch (the center-to-center distance of adjacent magnetic poles), :math:`\lambda_{fd}` is the flux linkage of the stator :math:`d`-axis winding due to flux produced by the rotor magnets, and :math:`i_{sq}` is the stator :math:`q`-axis current.
The instantaneous mechanical power absorbed by the PTO is given by:  

.. math::

	P_{pto}=-F_{pto}\dot{X}_{rel}

For more information about application of pto systems in WEC-Sim, refer to :ref:`advanced_features:Constraint and PTO Features` section.
	

.. _theory_mooring:

Mooring 
-------

.. note::
    This is in the wrong place, but I actually think the way you distribute the
    Moordyn binary contravenes its licence. GPL3 says that in order to distribute
    a binary without the source code it should be:
    
        "accompanied by a written offer, valid for at least three years and 
        valid for as long as you offer spare parts or customer support for 
        that product model, to give anyone who possesses the object code 
        either (1) a copy of the Corresponding Source for all the software in 
        the product that is covered by this License, on a durable physical 
        medium customarily used for software interchange, for a price no more 
        than your reasonable cost of physically performing this conveying of 
        source, or (2) access to copy the Corresponding Source from a network 
        server at no charge. "
     
     There is no such written offer in the https://github.com/WEC-Sim/moorDyn
     repo.

The mooring load is represented using a linear quasi-static mooring stiffness or by using the mooring forces calculated from `MoorDyn <http://www.matt-hall.ca/moordyn>`_ :cite:`Hall2015MoorDynGuide`, which is an open-source lumped-mass mooring dynamics model. 

Mooring Matrix
^^^^^^^^^^^^^^^^^^^^^^^
When linear quasi-static mooring stiffness is used, the mooring load can be calculated by

.. math::
	F_{m}=-K_{m}X-C_{m}\dot{X}

where :math:`K_{m}` and :math:`C_{m}` are the stiffness and damping matrices for the mooring system, and :math:`X` and :math:`\dot{X}` are the displacement and velocity of the body, respectively.

.. note::
    These matrices are user supplied?

MoorDyn
^^^^^^^^^^^^^^^^^^^^^^^
MoorDyn discretizes each mooring line in a mooring system into evenly-sized line segments connected by node points (see :ref:`MoorDyn figure <MoorDynFig>`). The line mass is lumped at these node points along with gravitational and buoyancy forces, hydrodynamic loads, and reactions from contact with the seabed.  Hydrodynamic drag and added mass are calculated based on Morison's equation.  A mooring line's axial stiffness is modeled by applying a linear stiffness to each line segment in tension only.  A damping term is also applied in each segment to dampen non-physical resonances caused by the lumped-mass discretization.  Bending and torsional stiffnesses are neglected.  Bottom contact is represented by vertical stiffness and damping forces applied at the nodes when a node is located below the seabed. :cite:`Hall2015ValidationData`.  

.. _MoorDynFig:

.. figure:: _images/MoorDyn_Graphic.png
   :scale: 70 %
   :align: center
    
   ..

   *MoorDyn mooring model elements*

For more information about application of mooring systems in WEC-Sim, refer to :ref:`advanced_features:Mooring Features` section.


Nonlinear Buoynancy and Froude-Krylov Wave Excitation
-----------------------------------------------------

.. note::
    Which linear model? Maybe "linear wave theory" is better here?

The linear model assumes that the body motion and the waves consist of small amplitudes in comparison to the wavelengths. A weakly nonlinear approach is applied to account for the nonlinear hydrodynamic forces induced by the instantaneous water surface elevation and body position. Rather than using the BEM calculated linear wave-excitation and hydrostatic coefficients, the nonlinear buoyancy and the Froude-Krylov force components can be obtained by integrating the static and dynamic pressures over each panel along the wetted body surface at each time step. 
Because linear wave theory is used to determine the flow velocity and pressure field, the values become unrealistically large for wetted panels that are above the mean water level. To correct this, the Wheeler stretching method is applied :cite:`wheeler1969methods`, which applies a correction to the instantaneous wave elevation that forces its height to be equal to the water depth when calculating the flow velocity and pressure,

 .. math::
	z^* = \frac{D(D+z)}{(D+\eta)} - D

where :math:`D` is the mean water depth, and :math:`\eta` is the z-value on the instantaneous water surface.

.. Note:: 
	The nonlinear WEC-Sim method is not intended to model highly nonlinear hydrodynamic events, such as wave slamming and wave breaking. 


For more information about application of nonlinear hydrodynamics in WEC-Sim, refer to :ref:`nonlinear` section.



Viscous Damping and Morison Elements
------------------------------------
Additional damping and added-mass can be added to the WEC system. This facilitates experimental validation of the WEC-Sim code, particularly in the event that the BEM hydrodynamic outputs are not sufficiently representative of the physical system.  

Viscous Damping
^^^^^^^^^^^^^^^^^^^^^^^

.. note::
    "Linear damping and quadratic drag forces add flexibility to the definition 
    of viscous forcing" is a cryptic sentence.

Linear damping and quadratic drag forces add flexibility to the definition of viscous forcing

 .. math::
	& F_{v}=-C_{v}\dot{X}-\frac{C_{d} \rho A_{d}}{2}\dot{X}|\dot{X}| & \\

	&  =-C_{v}\dot{X}-C_{D}\dot{X}|\dot{X}| & \\
	              

where :math:`C_{v}` is the linear (viscous) damping coefficient, :math:`C_{d}` is the quadratic drag coefficient, :math:`\rho` is the fluid density, and :math:`A_{d}` is the characteristic area for drag calculation. Alternatively, one can define :math:`C_{D}` directly.

Because BEM codes are potential flow solvers and neglect the effects of viscosity, :math:`F_{v}` generally must be included to accurately model device performance. However, it can be difficult to select representative drag coefficients, as they depend on device geometry, scale, and relative velocity between the body and the flow around it. Empirical data on the drag coefficient can be found in various literature and standards, but is generally limited to simple geometries evaluated at a limited number of scales and flow conditions. For realistic device geometries, the use of computational fluid dynamic simulations or experimental data is encouraged.

Morison Elements 
^^^^^^^^^^^^^^^^^^^^^^^

.. note::
    Does this not lead to double counting if you include this with the second
    the viscous damping equations? Shouldn't this be more like an either or, 
    rather than including both, as implied by :math:numref:`motion`?

The Morison Equation assumes that the fluid forces in an oscillating flow on a structure of slender cylinders or other similar geometries arise partly from pressure effects from potential flow and partly from viscous effects. A slender cylinder implies that the diameter, D, is small relative to the wave length, :math:`\lambda`, which is generally met when :math:`D/\lambda < 0.1 - 0.2`. If this condition is not met, wave diffraction effects must be taken into account. Assuming that the geometries are slender, the resulting force can be approximated by a modified Morison formulation :cite:`Morison1950`. The formulation for each element on the body can be given as

 .. math::
	F_{me}=\rho\forall\dot{v}+\rho\forall C_{a}(\dot{v}-\ddot{X})+\frac{C_{d}\rho A_{d}}{2}(v-\dot{X})|v-\dot{X}|

where :math:`v` is the fluid particle velocity due to wave and current, :math:`C_{a}` is the coefficient of added mass, and :math:`\forall` is the displaced volume. 

.. Note:: 
	WEC-Sim  does not consider buoyancy effects when calculating the forces from Morison elements. 

For more information about application of Morison Elements in WEC-Sim, refer to :ref:`morison` section.

Generalized Body Modes 
------------------------------------
Additional generalized body modes (GBM) are inlcuded to account for solving multibody system with relative body motions or the the dynamics and structural deformation, assuming the modal properties are given or can be simply obtained in closed-form expressions or finite element analysis. Once the hydrodynamic coefficients that include these additional flexible DOF are obtained from the BEM solver, the 6DOF rigid body motion for each body and the additional GBM DOFs are solved together in one system of equations. 

References
----------
.. bibliography:: WEC-Sim_Theory.bib
   :style: unsrt
